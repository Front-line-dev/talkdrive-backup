# 카카오톡 톡서랍 일괄 백업

톡서랍(talkcloud.kakao.com)에 저장된 사진/동영상을 오래된 순서부터 로컬에 백업합니다.

## 스크립트

| 파일 | 설명 |
|------|------|
| `backup.py` | 다운로드 후 서버에서 삭제 (백업 + 정리) |
| `download_only.py` | 다운로드만 수행, 서버 삭제 없음 |

### backup.py

- 오래된 파일부터 100개씩 가져와 다운로드
- 다운로드 성공한 파일만 서버에서 삭제
- 삭제된 파일은 다음 배치에서 자동으로 건너뛰므로 cursor 없이 항상 첫 페이지를 요청
- 실행할 때마다 설정된 용량(기본 5GB)까지 처리 후 중단

### download_only.py

- 서버에서 삭제하지 않으므로 cursor 기반 페이징으로 다음 페이지를 넘김
- 서버 데이터를 보존하면서 로컬 백업만 만들고 싶을 때 사용
- 실행할 때마다 설정된 용량(기본 5GB)까지 처리 후 중단
- 단, 삭제를 하지 않기 때문에 재실행 시 처음부터 다시 다운로드됨 (이미 받은 파일은 순번이 이어붙여짐)

## 사전 준비

1. Python 3 설치
2. requests 라이브러리 설치
   ```bash
   pip install requests
   ```
3. [Get cookies.txt locally](https://chrome.google.com/webstore/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc/) Chrome 확장 프로그램 설치
4. 브라우저에서 https://talkcloud.kakao.com 접속 및 카카오 계정으로 로그인
5. 확장 프로그램으로 쿠키 export → 파일명을 `talkcloud.kakao.com_cookies.txt`로 저장하여 프로젝트 폴더에 배치

![쿠키 내보내기](./cookie.PNG)

## 실행

```bash
# 백업 + 서버 삭제
python backup.py

# 다운로드만 (서버 삭제 없음)
python download_only.py
```

## 설정

각 스크립트 상단에서 수정 가능:

| 변수 | 기본값 | 설명 |
|------|--------|------|
| `BACKUP_PATH` | `./backups` | 다운로드 저장 경로 |
| `COOKIE_FILE` | `talkcloud.kakao.com_cookies.txt` | 쿠키 파일 경로 |
| `MAX_SIZE_BYTES` | `5 * 1024 * 1024 * 1024` (5GB) | 1회 실행당 최대 다운로드 용량 |
| `FETCH_COUNT` | `100` | API 요청 시 한 번에 가져올 파일 수 |
| `THREADS_COUNT` | `5` | 동시 다운로드 스레드 수 |
| `MAX_RETRIES` | `3` | 다운로드 실패 시 재시도 횟수 (1초 → 2초 → 4초 간격) |
| `TIMEOUT` | `(10, 60)` | (연결 타임아웃, 읽기 타임아웃) 초 단위 |

## 백업 폴더 구조

채팅방별 폴더(`chat_해시앞8자리`)로 분류되며, 파일명은 `YYYYMMDD_순번.확장자` 형식입니다.
같은 채팅방에서 같은 날짜에 여러 파일이 있으면 순번이 001, 002, 003... 으로 증가합니다.

```
backups/
├── chat_96e73c34/
│   ├── 20200611_001.jpg
│   ├── 20200611_002.jpg
│   ├── 20200624_001.mp4
│   └── 20200624_002.jpg
├── chat_99c8602a/
│   └── 20200616_001.jpg
└── ...
```

- 채팅방 폴더명의 해시는 카카오 API의 `hashedChatId` 앞 8자리입니다
- 채팅방 이름이나 참여자 이름은 API에서 제공하지 않아 해시로만 구분됩니다
- 날짜는 해당 파일이 톡서랍에 저장된 시점 기준입니다

## 안전장치

- **크기 검증**: 이미지(jpg, png 등)는 다운로드 크기와 API 메타데이터의 size를 비교하여 검증합니다. 동영상(mp4 등)은 서버 트랜스코딩으로 인해 메타데이터 크기와 실제 다운로드 크기가 다를 수 있어 0바이트 체크만 수행합니다.
- **성공 건만 삭제** (backup.py): 다운로드에 성공한 파일만 서버에서 삭제합니다. 실패한 파일은 서버에 그대로 남아 다음 실행 시 재시도됩니다.
- **자동 재시도**: 다운로드 실패 시 최대 3회 재시도합니다 (1초, 2초, 4초 간격의 지수 백오프).
- **청크 다운로드**: 대용량 파일을 1MB 단위로 나눠 저장하여 메모리 부족 및 불완전 다운로드를 방지합니다.
- **세션 재사용**: TCP 연결 풀링으로 매번 새 연결을 맺지 않아 안정성과 속도가 향상됩니다.
- **용량 제한**: 실제 다운로드된 바이트 기준으로 설정된 용량에 도달하면 자동 중단됩니다. 동영상은 메타데이터 크기와 실제 다운로드 크기가 다르기 때문에 메타데이터가 아닌 실제 저장된 크기로 누적 계산합니다. 배치(100개) 단위로 체크하므로 최대 1배치분만큼 초과할 수 있습니다.
- **재실행 안전**: 폴더 내 기존 파일의 순번을 확인하고 이어서 부여합니다.

## 알려진 이슈

- **동영상 크기 불일치**: 카카오 API 메타데이터의 `size` 필드와 실제 `?attach` 다운로드 크기가 동영상(mp4)에서 일치하지 않습니다. 서버에서 트랜스코딩된 버전을 내려주는 것으로 추정됩니다. 이 때문에 동영상은 크기 검증 대신 0바이트 체크만 수행합니다.
- **채팅방 식별 불가**: API가 채팅방 이름이나 참여자 정보를 제공하지 않아 해시값(`hashedChatId` 앞 8자리)으로만 구분됩니다. 어떤 채팅방인지 확인하려면 폴더 안의 사진 내용으로 직접 판단해야 합니다.
- **원본 파일명 없음**: 원래 파일명은 API에 포함되지 않으며, 카카오 서버가 생성한 랜덤 이름만 존재합니다. 스크립트에서 `날짜_순번` 형식으로 재명명합니다.

## 참고

- 쿠키는 일정 시간이 지나면 만료됩니다. 인증 오류가 발생하면 쿠키를 다시 export 해주세요.
- `drive.kakao.com_cookies.txt`는 구버전 쿠키 파일입니다. 현재는 `talkcloud.kakao.com_cookies.txt`를 사용합니다.
- API 엔드포인트는 `drawer-api.kakao.com`이며, CDN은 `drawer-cdn.kakao.com`입니다. `talkcloud.kakao.com` 쿠키로 인증됩니다.
